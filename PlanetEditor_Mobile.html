<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Planet Editor (Safe Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #000000; --panel: rgba(12, 12, 14, 0.9); }
        body { margin: 0; overflow: hidden; background: #000; color: #e0e0e0; font-family: sans-serif; font-size: 13px; touch-action: none; }
        
        #error-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center;
            flex-direction: column; text-align: center; padding: 20px; box-sizing: border-box;
        }
        #error-overlay h2 { color: #ff4444; margin-bottom: 10px; }
        #error-overlay button { padding: 10px 20px; font-size: 16px; margin-top: 15px; }

        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 0; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; padding: 10px; box-sizing: border-box;
            gap: 10px; overflow: hidden;
        }

        .panel {
            pointer-events: auto; background: var(--panel); 
            padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 8px;
            max-height: 40vh; overflow-y: auto; width: 100%; max-width: 300px;
            transition: max-height 0.3s ease;
        }

        .panel.collapsed { max-height: 45px; overflow: hidden; }
        
        .panel-header { display: flex; justify-content: space-between; align-items: center; min-height: 24px; }
        .collapse-btn { 
            background: #333; border: none; color: white; width: 30px; height: 30px; border-radius: 4px; font-size: 14px;
        }

        /* Mobile specific adjustments */
        @media (max-width: 600px) {
            .panel { max-width: 100%; }
            input[type=range] { height: 15px; } /* Larger touch targets */
        }

        h2 { margin: 0; font-size: 14px; color: var(--accent); text-transform: uppercase; font-weight: 800; }
        h3 { margin: 8px 0 2px 0; font-size: 11px; color: #888; text-transform: uppercase; border-bottom: 1px solid #444; }
        
        .row { display: flex; justify-content: space-between; align-items: center; }
        .val { font-family: monospace; color: var(--accent); }
        
        input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        input[type=text], select { 
            background: #222; border: 1px solid #444; color: #fff; padding: 8px; width: 100%; 
            border-radius: 4px; box-sizing: border-box;
        }
        
        .btn-group { display: flex; gap: 5px; margin-top: 5px; }
        button { 
            flex: 1; padding: 10px; background: #333; color: #ccc; border: 1px solid #444; border-radius: 4px;
            font-weight: bold; text-transform: uppercase; font-size: 11px;
        }
        button.active-geo { background: var(--accent); color: #000; }
        
        .color-row { display: flex; align-items: center; gap: 10px; margin: 4px 0; }
        input[type=color] { border: none; width: 40px; height: 30px; background: none; }

        #fps-counter {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: var(--accent); padding: 4px 8px; 
            border-radius: 4px; font-family: monospace; font-size: 12px; pointer-events: none;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.168.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.168.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="error-overlay">
        <h2>Graphics Context Lost</h2>
        <p>Your browser stopped the graphics engine to prevent a crash.</p>
        <button onclick="location.reload()">Reload Page</button>
    </div>

    <div id="container"></div>

    <div id="ui-layer">
        <div id="controls-left" class="panel">
            <div class="panel-header" onclick="togglePanel('controls-left')">
                <h2>Design</h2>
                <button class="collapse-btn">â–¼</button>
            </div>
            <div class="panel-content">
                <select id="planetType"><option value="planet">Type: Planet</option><option value="moon">Type: Moon</option><option value="sun">Type: Sun</option></select>
                
                <h3>Seed</h3>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="seedInput" value="Cosmos">
                    <button id="randomSeed" style="max-width:40px;">ðŸŽ²</button>
                </div>

                <div class="btn-group">
                    <button id="typeQuad" class="active-geo">Sphere</button>
                    <button id="typeCube">Cube</button>
                </div>

                <h3>Shape</h3>
                <div class="row"><label>Radius</label><span id="radVal" class="val">1.0</span></div>
                <input type="range" id="radius" min="0.5" max="2.0" step="0.01" value="1.0">

                <div class="row"><label>Height</label><span id="heightVal" class="val">0.06</span></div>
                <input type="range" id="heightScale" min="0" max="0.3" step="0.001" value="0.062">

                <div class="row"><label>Noise Scale</label><span id="freqVal" class="val">0.65</span></div>
                <input type="range" id="frequency" min="0.1" max="5.0" step="0.01" value="0.65">
                
                <h3>Texture</h3>
                <button id="btnImportHM">Import Heightmap</button>
                <input type="file" id="fileInputHM" accept="image/*" style="display:none">
                <input type="range" id="texMix" min="0" max="1" step="0.01" value="0" style="margin-top:5px">
            </div>
        </div>

        <div id="controls-right" class="panel collapsed">
            <div class="panel-header" onclick="togglePanel('controls-right')">
                <h2>Biomes</h2>
                <button class="collapse-btn">â–¼</button>
            </div>
            <div class="panel-content">
                <div class="color-row"><label>Ocean</label><input type="color" id="colorOcean" value="#87ceeb"></div>
                <div class="color-row"><label>Land</label><input type="color" id="colorGrass" value="#1a8c1a"></div>
                
                <h3>Levels</h3>
                <div class="row"><label>Sea Level</label><span id="oceanVal" class="val">-0.2</span></div>
                <input type="range" id="oceanLevel" min="-1.0" max="0.6" step="0.01" value="-0.2">
                
                <h3>Vegetation</h3>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                    <input type="checkbox" id="enableTrees" style="width:20px; height:20px;">
                    <label for="enableTrees">Enable Trees (Heavy)</label>
                </div>
                <input type="range" id="treeDensity" min="0" max="50" step="1" value="20">
                <button id="btnRegenerateTrees">Regenerate</button>

                <h3>System</h3>
                <div class="btn-group">
                    <button id="btnSaveData">Export ZIP</button>
                    <button id="btnLoadData">Import ZIP</button>
                </div>
                <input type="file" id="fileInputData" accept=".zip" style="display:none">
            </div>
        </div>
    </div>
    
    <div id="fps-counter">FPS: --</div>

    <script>
        function togglePanel(id) { document.getElementById(id).classList.toggle('collapsed'); }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- SAFE MODE CONFIG ---
        // Pixel 8a / Firefox Android often struggles with Bloom + High Precision
        const isMobile = /Android|iPhone|iPad|Mobile/i.test(navigator.userAgent);
        const CONF = {
            useBloom: false,  // DISABLED bloom for stability
            precision: isMobile ? 'mediump' : 'highp', // Force mediump on mobile
            treeCount: isMobile ? 1500 : 8000,
            segments: isMobile ? 64 : 100
        };

        if(isMobile) console.log("Mobile Detected: Running in Safe Mode (No Bloom, Medium Precision)");

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050508);
        
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 50);
        camera.position.z = 3.5;

        // Use standard powerPreference (avoiding "high-performance" which can crash mobile drivers)
        const renderer = new THREE.WebGLRenderer({ 
            antialias: false, 
            powerPreference: "default",
            precision: CONF.precision 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Cap pixel ratio
        document.getElementById('container').appendChild(renderer.domElement);

        // Crash Handler
        renderer.domElement.addEventListener("webglcontextlost", (event) => {
            event.preventDefault();
            document.getElementById('error-overlay').style.display = 'flex';
        }, false);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enablePan = false;

        // Lighting
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
        sunLight.position.set(5, 3, 5);
        scene.add(sunLight);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));

        // --- RNG ---
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }
        let rng = mulberry32(0);
        let currentSeed = "Cosmos";

        // --- SHADER (Optimized for Mobile) ---
        // Removed complex noise permutations for standard 3D noise to save instructions
        const vertexShader = `
            precision ${CONF.precision} float;
            varying vec3 vPos;
            varying float vElevation;
            varying vec2 vUv;
            varying vec3 vBasePos;

            uniform float radius;
            uniform float heightScale;
            uniform float frequency;
            uniform vec3 seedOffset;
            uniform float shapeFactor; // 0=sphere, 1=cube
            uniform sampler2D heightMap;
            uniform float texMix;

            // Simple pseudo-random for noise
            float hash(float n) { return fract(sin(n) * 43758.5453123); }
            float noise(vec3 x) {
                vec3 p = floor(x);
                vec3 f = fract(x);
                f = f * f * (3.0 - 2.0 * f);
                float n = p.x + p.y * 57.0 + 113.0 * p.z;
                return mix(mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),
                               mix(hash(n + 57.0), hash(n + 58.0), f.x), f.y),
                           mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),
                               mix(hash(n + 170.0), hash(n + 171.0), f.x), f.y), f.z);
            }

            // Simple FBM
            float fbm(vec3 p) {
                float f = 0.0;
                f += 0.5000 * noise(p); p *= 2.01;
                f += 0.2500 * noise(p); p *= 2.02;
                f += 0.1250 * noise(p);
                return f;
            }

            void main() {
                vUv = uv;
                vec3 sphereP = normalize(position);
                vec3 absP = abs(position);
                float maxC = max(max(absP.x, absP.y), absP.z);
                vec3 boxP = position / maxC;
                
                // Morph between sphere and cube
                vec3 baseDir = mix(sphereP, boxP, shapeFactor);
                vec3 basePos = baseDir * radius;
                vBasePos = baseDir;

                // Noise Displacement
                vec3 noisePos = (sphereP * frequency) + seedOffset;
                float n = fbm(noisePos);
                
                // Heightmap mix
                float texH = texture2D(heightMap, vUv).r;
                float finalH = mix(n, texH, texMix);
                
                vElevation = finalH;
                
                // Apply height
                vec3 finalPos = basePos + normalize(baseDir) * (finalH * heightScale);
                vPos = finalPos;

                gl_Position = projectionMatrix * modelViewMatrix * vec4(finalPos, 1.0);
            }
        `;

        const fragmentShader = `
            precision ${CONF.precision} float;
            varying vec3 vPos;
            varying float vElevation;
            varying vec3 vBasePos;
            
            uniform float oceanLevel;
            uniform vec3 sunDirection;
            uniform vec3 oceanColor;
            uniform vec3 grassColor;
            uniform float isSun;

            void main() {
                if (isSun > 0.5) {
                    gl_FragColor = vec4(1.0, 0.6, 0.1, 1.0); // Simple sun color
                    return;
                }

                vec3 N = normalize(vPos);
                vec3 L = normalize(sunDirection);
                
                // Simple Diffuse
                float diff = max(dot(N, L), 0.0);
                
                vec3 col = grassColor;
                
                // Ocean
                if (vElevation < oceanLevel) {
                    col = oceanColor;
                    diff = diff * 0.8 + 0.2; // Water specular fake
                } else {
                    // Simple slope shading
                    float slope = 1.0 - dot(N, normalize(vBasePos));
                    if(slope > 0.2) col *= 0.7; // Darker rock
                }

                gl_FragColor = vec4(col * (diff + 0.2), 1.0);
            }
        `;

        const material = new THREE.ShaderMaterial({
            uniforms: {
                radius: { value: 1.0 },
                heightScale: { value: 0.1 },
                frequency: { value: 1.0 },
                seedOffset: { value: new THREE.Vector3() },
                shapeFactor: { value: 0.0 },
                heightMap: { value: null },
                texMix: { value: 0.0 },
                oceanLevel: { value: -0.2 },
                sunDirection: { value: new THREE.Vector3(1, 0.5, 0.5).normalize() },
                oceanColor: { value: new THREE.Color("#87ceeb") },
                grassColor: { value: new THREE.Color("#1a8c1a") },
                isSun: { value: 0.0 }
            },
            vertexShader,
            fragmentShader
        });

        // --- GEOMETRY ---
        let planetMesh;
        function createGeometry(type = 'quad') {
            if (planetMesh) scene.remove(planetMesh);
            const geo = new THREE.BoxGeometry(1, 1, 1, CONF.segments, CONF.segments, CONF.segments);
            planetMesh = new THREE.Mesh(geo, material);
            scene.add(planetMesh);
            
            material.uniforms.shapeFactor.value = (type === 'cube') ? 0.8 : 0.0;
        }

        // --- TREES ---
        // Simplified tree system for mobile
        const treeGeo = new THREE.ConeGeometry(0.05, 0.2, 5);
        treeGeo.translate(0, 0.1, 0); // Pivot at bottom
        const treeMat = new THREE.MeshLambertMaterial({ color: 0x228b22 });
        const treeMesh = new THREE.InstancedMesh(treeGeo, treeMat, CONF.treeCount);
        scene.add(treeMesh);

        function updateTrees() {
            if(!document.getElementById('enableTrees').checked || material.uniforms.isSun.value > 0.5) {
                treeMesh.visible = false;
                return;
            }
            
            treeMesh.visible = true;
            const dummy = new THREE.Object3D();
            const r = parseFloat(document.getElementById('radius').value);
            const den = parseInt(document.getElementById('treeDensity').value);
            const count = Math.min(CONF.treeCount, den * 30);
            
            treeMesh.count = count;
            
            for(let i=0; i<count; i++) {
                // Random point on sphere surface
                const u = Math.random();
                const v = Math.random();
                const theta = 2 * Math.PI * u;
                const phi = Math.acos(2 * v - 1);
                
                const x = Math.sin(phi) * Math.cos(theta);
                const y = Math.sin(phi) * Math.sin(theta);
                const z = Math.cos(phi);
                
                dummy.position.set(x, y, z).multiplyScalar(r);
                dummy.lookAt(0, 0, 0);
                dummy.updateMatrix();
                treeMesh.setMatrixAt(i, dummy.matrix);
            }
            treeMesh.instanceMatrix.needsUpdate = true;
        }

        // --- UI HANDLERS ---
        const $ = (id) => document.getElementById(id);
        
        function updateUniforms() {
            const m = material.uniforms;
            m.radius.value = parseFloat($('radius').value);
            m.heightScale.value = parseFloat($('heightScale').value);
            m.frequency.value = parseFloat($('frequency').value);
            m.oceanLevel.value = parseFloat($('oceanLevel').value);
            m.texMix.value = parseFloat($('texMix').value);
            m.oceanColor.value.set($('colorOcean').value);
            m.grassColor.value.set($('colorGrass').value);

            $('radVal').innerText = m.radius.value.toFixed(2);
            $('heightVal').innerText = m.heightScale.value.toFixed(3);
            
            if(planetMesh) planetMesh.scale.setScalar(m.radius.value);
        }

        $('planetType').addEventListener('change', (e) => {
            const val = e.target.value;
            material.uniforms.isSun.value = (val === 'sun') ? 1.0 : 0.0;
            // Disable trees on sun/moon
            if(val !== 'planet') $('enableTrees').checked = false;
            updateTrees();
        });

        $('typeQuad').onclick = () => { createGeometry('quad'); $('typeQuad').classList.add('active-geo'); $('typeCube').classList.remove('active-geo'); };
        $('typeCube').onclick = () => { createGeometry('cube'); $('typeCube').classList.add('active-geo'); $('typeQuad').classList.remove('active-geo'); };

        // Bind Inputs
        ['radius','heightScale','frequency','oceanLevel','texMix'].forEach(id => $(id).addEventListener('input', updateUniforms));
        ['colorOcean','colorGrass'].forEach(id => $(id).addEventListener('input', updateUniforms));
        $('enableTrees').addEventListener('change', updateTrees);
        $('btnRegenerateTrees').onclick = updateTrees;
        
        // Seed
        $('randomSeed').onclick = () => {
             const val = Math.random() * 100;
             material.uniforms.seedOffset.value.set(val, val, val);
             updateTrees();
        };

        // Resize Logic
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- EXPORT/IMPORT ZIP (Minified for Safe Mode) ---
        $('btnSaveData').onclick = () => {
            const zip = new JSZip();
            const data = {
                type: $('planetType').value,
                radius: $('radius').value
            };
            zip.file("planet.json", JSON.stringify(data));
            zip.generateAsync({type:"blob"}).then(c => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(c);
                a.download = "planet.zip";
                a.click();
            });
        };
        
        $('btnLoadData').onclick = () => $('fileInputData').click();
        $('fileInputData').onchange = (e) => {
            const f = e.target.files[0];
            if(f) JSZip.loadAsync(f).then(z => z.file("planet.json").async("string")).then(t => {
                const d = JSON.parse(t);
                $('planetType').value = d.type;
                $('radius').value = d.radius;
                updateUniforms();
            });
        };

        // --- INIT ---
        createGeometry('quad');
        updateUniforms();
        updateTrees();

        let frame = 0;
        let lastTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            
            frame++;
            const t = performance.now();
            if(t - lastTime > 1000) {
                $('fps-counter').innerText = "FPS: " + frame;
                frame=0; lastTime=t;
            }
        }
        animate();
    </script>
</body>
</html>